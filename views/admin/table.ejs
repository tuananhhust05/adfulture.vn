<div class="apple-wrapper">
    <aside class="apple-sidebar">
        <div class="apple-sidebar-logo">
            <a href="/admin/dashboard">
                <img src="/assets/logo/logo.png" alt="AdFuture">
                AdFuture
            </a>
        </div>
        
        <ul class="apple-nav">
            <li class="apple-nav-item">
                <a href="/admin/dashboard" class="apple-nav-link">
                    <i class="fa-solid fa-chart-line"></i>
                    Lưu lượng truy cập
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/table" class="apple-nav-link active">
                    <i class="fa-solid fa-box"></i>
                    Bảng tổng hợp sản phẩm
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/tablehomepage" class="apple-nav-link">
                    <i class="fa-solid fa-home"></i>
                    Sản phẩm trang chủ
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/editprice" class="apple-nav-link">
                    <i class="fa-solid fa-tags"></i>
                    Chỉnh sửa báo giá
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/listRequestCustomer" class="apple-nav-link">
                    <i class="fa-solid fa-envelope"></i>
                    Ý kiến phản hồi
                    <span class="apple-nav-badge" id="notification_count_unreadrequest">0</span>
                </a>
            </li>
        </ul>
    </aside>

    <main class="apple-main">
        <header class="apple-header">
            <button class="apple-menu-toggle" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
            <h1 class="apple-header-title">Bảng tổng hợp sản phẩm</h1>
            <div class="apple-header-actions">
                <a href="/admin/login" class="apple-btn apple-btn-secondary">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    Đăng xuất
                </a>
            </div>
        </header>

        <div class="apple-content">
            <div class="apple-card">
                <div class="apple-card-header">
                    <h2 class="apple-card-title">Danh sách sản phẩm</h2>
                    <p class="apple-card-subtitle">Quản lý và chỉnh sửa thông tin sản phẩm hiển thị trên website</p>
                </div>
                <div class="apple-card-body">
                    <div class="apple-card-actions mb-4">
                        <select class="apple-select" id="selectType" onchange="handleChangeType(this.value)">
                            <option value="all">Tất cả loại</option>
                            <option value="streethouse">Nhà phố</option>
                            <option value="garden-house">Nhà vườn</option>
                            <option value="building-home">Nhà cao tầng</option>
                            <option value="small-house4">Nhà nhỏ</option>
                            <option value="villa">Biệt thự</option>
                        </select>
                        <select class="apple-select" id="selectTypeAdd" style="display: none;" onchange="handleChangeTypeAdd(this.value)">
                        </select>
                        <button class="apple-btn apple-btn-success" onclick="SaveChange()">
                            <i class="fa-solid fa-save"></i> Lưu thay đổi
                        </button>
                        <button class="apple-btn apple-btn-primary" onclick="handleOpenModal()">
                            <i class="fa-solid fa-plus"></i> Thêm sản phẩm
                        </button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="apple-table">
                            <thead>
                                <tr>
                                    <th>Địa điểm</th>
                                    <th>Tiêu đề</th>
                                    <th>Loại sản phẩm</th>
                                    <th>Phân khúc</th>
                                    <th>Hình ảnh</th>
                                    <th>Upload</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="data_table_root">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <footer class="apple-footer">
            &copy; 2024 AdFuture. All rights reserved.
        </footer>
    </main>
</div>

<div class="apple-modal-overlay" id="productModal">
    <div class="apple-modal">
        <div class="apple-modal-header">
            <h3 class="apple-modal-title">Thêm sản phẩm mới</h3>
            <button class="apple-modal-close" onclick="handleCloseModal()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="apple-modal-body">
            <div class="apple-form-group">
                <label class="apple-form-label">Loại sản phẩm</label>
                <input type="text" class="apple-input" id="create_type" placeholder="VD: streethouse, villa...">
            </div>
            <div class="apple-form-group">
                <label class="apple-form-label">Tiêu đề</label>
                <input type="text" class="apple-input" id="create_title" placeholder="Nhập tiêu đề sản phẩm">
            </div>
            <div class="apple-form-group">
                <label class="apple-form-label">Địa điểm</label>
                <input type="text" class="apple-input" id="create_site" placeholder="Nhập địa điểm">
            </div>
            <div class="apple-form-group">
                <label class="apple-form-label">Phân khúc</label>
                <input type="text" class="apple-input" id="create_typeAdd" placeholder="VD: np2t, bt1t...">
            </div>
        </div>
        <div class="apple-modal-footer">
            <button class="apple-btn apple-btn-secondary" onclick="handleCloseModal()">Hủy</button>
            <button class="apple-btn apple-btn-primary" onclick="CreateProduct()">Thêm sản phẩm</button>
        </div>
    </div>
</div>

<script>
    let type = "all";
    let typeAdd = 'all';
    let tokenJWT = localStorage['token'];
    let arrIdChange = [];

    if (localStorage['countUnreaderRequest']) {
        document.getElementById('notification_count_unreadrequest').textContent = localStorage['countUnreaderRequest'];
    }

    const handleOpenModal = () => document.getElementById('productModal').classList.add('active');
    const handleCloseModal = () => document.getElementById('productModal').classList.remove('active');

    const takeDataTable = async () => {
        try {
            const res = await axios({
                method: "post",
                url: "/api/admin/homepage/GetListProduct",
                data: { type, typeAdd, tokenJWT },
                headers: { "Content-Type": "multipart/form-data" }
            });
            
            if (res.data?.data) {
                const tbody = document.getElementById('data_table_root');
                tbody.innerHTML = '';
                
                res.data.data.forEach(item => {
                    tbody.innerHTML += `
                        <tr id="${item._id}">
                            <td><input type="text" class="apple-input apple-input-sm" id="${item._id}site" value="${item.site}" onchange="ChangeDataProduct('${item._id}')"></td>
                            <td><input type="text" class="apple-input apple-input-sm" id="${item._id}title" value="${item.title}" onchange="ChangeDataProduct('${item._id}')"></td>
                            <td><input type="text" class="apple-input apple-input-sm" id="${item._id}type" value="${item.type}" onchange="ChangeDataProduct('${item._id}')"></td>
                            <td><input type="text" class="apple-input apple-input-sm" id="${item._id}typeAdd" value="${item.typeAdd || ''}" onchange="ChangeDataProduct('${item._id}')"></td>
                            <td><img class="apple-img-thumb" id="${item._id}img" src="${item.img?.[0] || ''}" alt=""></td>
                            <td>
                                <div class="apple-file-input">
                                    <input type="file" id="file${item._id}" onchange="StartUploadFile('${item._id}')">
                                    <span class="apple-file-label"><i class="fa-solid fa-upload"></i> Upload</span>
                                </div>
                            </td>
                            <td>
                                <button class="apple-btn apple-btn-danger apple-btn-sm" onclick="DeleteProduct('${item._id}')">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                window.location.href = "/admin/login";
            }
        } catch (error) {
            console.error('Error:', error);
        }
    };

    const handleChangeType = (value) => {
        type = value;
        typeAdd = 'all';
        const selectTypeAdd = document.getElementById('selectTypeAdd');
        
        if (type === 'streethouse') {
            selectTypeAdd.style.display = 'block';
            selectTypeAdd.innerHTML = '<option value="all">Tất cả</option><option value="np2t">Nhà 2 tầng</option><option value="np3t">Nhà 3 tầng</option><option value="np4t">Nhà 4 tầng</option>';
        } else if (type === 'villa') {
            selectTypeAdd.style.display = 'block';
            selectTypeAdd.innerHTML = '<option value="all">Tất cả</option><option value="bt1t">Biệt thự 1 tầng</option><option value="bt2t">Biệt thự 2 tầng</option><option value="bt3t">Biệt thự 3 tầng</option>';
        } else {
            selectTypeAdd.style.display = 'none';
        }
        takeDataTable();
    };

    const handleChangeTypeAdd = (value) => {
        typeAdd = value;
        takeDataTable();
    };

    const ChangeDataProduct = (id) => {
        if (!arrIdChange.includes(id)) arrIdChange.push(id);
    };

    const SaveChange = async () => {
        if (arrIdChange.length === 0) return alert('Không có thay đổi nào để lưu');
        
        for (const id of arrIdChange) {
            await axios({
                method: "post",
                url: "/api/admin/homepage/EditProduct",
                data: {
                    site: document.getElementById(`${id}site`).value,
                    title: document.getElementById(`${id}title`).value,
                    type: document.getElementById(`${id}type`).value,
                    typeAdd: document.getElementById(`${id}typeAdd`).value,
                    _id: id,
                    tokenJWT
                },
                headers: { "Content-Type": "multipart/form-data" }
            });
        }
        arrIdChange = [];
        alert('Đã lưu thành công!');
    };

    const StartUploadFile = async (id) => {
        const file = document.getElementById(`file${id}`).files[0];
        if (!file) return;
        
        const fd = new FormData();
        fd.append('file', file);
        fd.append('IdProduct', id);
        fd.append('tokenJWT', tokenJWT);
        
        const res = await axios.post('/api/admin/file/upload/product', fd, {
            headers: { 'Content-Type': 'multipart/form-data' }
        });
        
        if (res.data?.data) {
            document.getElementById(`${id}img`).src = res.data.data;
        }
    };

    const CreateProduct = async () => {
        const res = await axios({
            method: "post",
            url: "/api/admin/homepage/CreateProduct",
            data: {
                site: document.getElementById('create_site').value,
                title: document.getElementById('create_title').value,
                type: document.getElementById('create_type').value,
                typeAdd: document.getElementById('create_typeAdd').value,
                tokenJWT
            },
            headers: { "Content-Type": "multipart/form-data" }
        });
        
        if (res.data?.data) {
            handleCloseModal();
            takeDataTable();
        }
    };

    const DeleteProduct = async (id) => {
        if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;
        
        await axios({
            method: "post",
            url: "/api/admin/homepage/DeleteProduct",
            data: { _id: id, tokenJWT },
            headers: { "Content-Type": "multipart/form-data" }
        });
        document.getElementById(id).remove();
    };

    takeDataTable();
</script>
