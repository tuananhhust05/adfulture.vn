<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>

<div class="apple-wrapper">
    <!-- Sidebar -->
    <aside class="apple-sidebar">
        <div class="apple-sidebar-logo">
            <a href="/admin/dashboard">
                <img src="/assets/logo/logo.png" alt="AdFuture">
                AdFuture
            </a>
        </div>
        
        <ul class="apple-nav">
            <li class="apple-nav-item">
                <a href="/admin/dashboard" class="apple-nav-link active">
                    <i class="fa-solid fa-chart-line"></i>
                    Lưu lượng truy cập
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/table" class="apple-nav-link">
                    <i class="fa-solid fa-box"></i>
                    Bảng tổng hợp sản phẩm
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/tablehomepage" class="apple-nav-link">
                    <i class="fa-solid fa-home"></i>
                    Sản phẩm trang chủ
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/editprice" class="apple-nav-link">
                    <i class="fa-solid fa-tags"></i>
                    Chỉnh sửa báo giá
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/listRequestCustomer" class="apple-nav-link">
                    <i class="fa-solid fa-envelope"></i>
                    Ý kiến phản hồi
                    <span class="apple-nav-badge" id="notification_count_unreadrequest">0</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="apple-main">
        <header class="apple-header">
            <button class="apple-menu-toggle" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
            <h1 class="apple-header-title">Dashboard</h1>
            <div class="apple-header-actions">
                <a href="/admin/login" class="apple-btn apple-btn-secondary">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    Đăng xuất
                </a>
            </div>
        </header>

        <div class="apple-content">
            <!-- Loading State -->
            <div id="loading-state" class="apple-card" style="text-align: center; padding: 60px;">
                <div class="apple-loading"></div>
                <p style="margin-top: 16px; color: var(--apple-text-secondary);">Đang tải dữ liệu...</p>
            </div>
            
            <!-- Error State -->
            <div id="error-state" class="apple-card" style="display: none; text-align: center; padding: 60px;">
                <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; color: var(--apple-orange); margin-bottom: 16px;"></i>
                <h3 style="margin-bottom: 8px;">Không thể tải dữ liệu</h3>
                <p style="color: var(--apple-text-secondary); margin-bottom: 16px;" id="error-message">Vui lòng kiểm tra kết nối và thử lại.</p>
                <button class="apple-btn apple-btn-primary" onclick="fetchDashboardData()">Thử lại</button>
            </div>
            
            <!-- Main Content (hidden initially) -->
            <div id="main-content" style="display: none;">
                <!-- Stats Grid -->
                <div class="apple-grid apple-grid-4 mb-4" id="stats-grid">
                    <div class="apple-stat-card">
                        <div class="apple-stat-value" id="stat-today">0</div>
                        <div class="apple-stat-label">Truy cập hôm nay</div>
                    </div>
                    <div class="apple-stat-card">
                        <div class="apple-stat-value" id="stat-yesterday">0</div>
                        <div class="apple-stat-label">Truy cập hôm qua</div>
                    </div>
                    <div class="apple-stat-card">
                        <div class="apple-stat-value" id="stat-month">0</div>
                        <div class="apple-stat-label">Truy cập tháng này</div>
                    </div>
                    <div class="apple-stat-card">
                        <div class="apple-stat-value" id="stat-lastmonth">0</div>
                        <div class="apple-stat-label">Truy cập tháng trước</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="apple-grid apple-grid-2 mb-4">
                    <div class="apple-chart-container">
                        <h3 class="apple-chart-title">Thống kê theo ngày</h3>
                        <canvas id="dailyChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="apple-chart-container">
                        <h3 class="apple-chart-title">Thống kê theo tháng</h3>
                        <canvas id="monthlyChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <div class="apple-grid apple-grid-2">
                    <div class="apple-chart-container">
                        <h3 class="apple-chart-title">So sánh ngày</h3>
                        <canvas id="dayCompareChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="apple-chart-container">
                        <h3 class="apple-chart-title">So sánh tháng</h3>
                        <canvas id="monthCompareChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <footer class="apple-footer">
            &copy; 2024 AdFuture. All rights reserved.
        </footer>
    </main>
</div>

<script>
    let tokenJWT = localStorage['token'];
    
    const chartColors = {
        blue: 'rgb(0, 113, 227)',
        blueLight: 'rgba(0, 113, 227, 0.1)',
        purple: 'rgb(175, 82, 222)',
        purpleLight: 'rgba(175, 82, 222, 0.1)',
        green: 'rgb(52, 199, 89)',
        red: 'rgb(255, 59, 48)',
        orange: 'rgb(255, 149, 0)',
        gray: 'rgb(142, 142, 147)'
    };

    Chart.defaults.global.defaultFontFamily = "-apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif";

    const showLoading = () => {
        document.getElementById('loading-state').style.display = 'block';
        document.getElementById('error-state').style.display = 'none';
        document.getElementById('main-content').style.display = 'none';
    };
    
    const showError = (message) => {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('error-message').textContent = message || 'Vui lòng kiểm tra kết nối và thử lại.';
    };
    
    const showContent = () => {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
    };

    const fetchDashboardData = async () => {
        showLoading();
        
        try {
            const res = await axios({
                method: "post",
                url: "/api/admin/contact/CountUnreaderRequest",
                data: { tokenJWT },
                headers: { "Content-Type": "multipart/form-data" }
            });
            
            if (res?.data?.data?.count !== undefined) {
                localStorage.setItem('countUnreaderRequest', String(res.data.data.count));
                document.getElementById('notification_count_unreadrequest').textContent = res.data.data.count;
            }

            const chartRes = await axios({
                method: "post",
                url: "/api/admin/homepage/TakeDataChart",
                data: { tokenJWT },
                headers: { "Content-Type": "multipart/form-data" }
            });

            console.log('Chart Response:', chartRes.data);

            if (chartRes.data?.data) {
                showContent();
                renderCharts(chartRes.data.data);
            } else if (chartRes.data?.error) {
                showError(chartRes.data.error);
            } else {
                showError('Token không hợp lệ. Vui lòng đăng nhập lại.');
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            showError('Lỗi kết nối server: ' + (error.message || 'Unknown error'));
        }
    };

    const renderCharts = (data) => {
        const { listResultDate, listHitoryMonth } = data;
        
        console.log('Rendering charts with data:', { listResultDate, listHitoryMonth });

        if (!listResultDate || !listHitoryMonth) {
            console.error('Missing chart data');
            return;
        }

        // Update stats
        if (listResultDate.length >= 2) {
            document.getElementById('stat-today').textContent = listResultDate[0]?.count || 0;
            document.getElementById('stat-yesterday').textContent = listResultDate[1]?.count || 0;
        }
        if (listHitoryMonth.length >= 2) {
            document.getElementById('stat-month').textContent = listHitoryMonth[0]?.count || 0;
            document.getElementById('stat-lastmonth').textContent = listHitoryMonth[1]?.count || 0;
        }

        // Daily Chart
        const dailyLabels = listResultDate.map(item => `${item.day}/${item.month}`);
        const dailyData = listResultDate.map(item => item.count);
        
        new Chart(document.getElementById('dailyChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: 'Lượt truy cập',
                    data: dailyData,
                    backgroundColor: chartColors.blue,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                legend: { display: false },
                scales: {
                    yAxes: [{
                        ticks: { beginAtZero: true },
                        gridLines: { color: 'rgba(0, 0, 0, 0.05)' }
                    }],
                    xAxes: [{
                        gridLines: { display: false }
                    }]
                }
            }
        });

        // Monthly Chart
        const monthlyLabels = listHitoryMonth.map(item => `${item.month}/${item.year}`);
        const monthlyData = listHitoryMonth.map(item => item.count);
        
        new Chart(document.getElementById('monthlyChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: monthlyLabels,
                datasets: [{
                    label: 'Lượt truy cập',
                    data: monthlyData,
                    backgroundColor: chartColors.purple
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                legend: { display: false },
                scales: {
                    yAxes: [{
                        ticks: { beginAtZero: true },
                        gridLines: { color: 'rgba(0, 0, 0, 0.05)' }
                    }],
                    xAxes: [{
                        gridLines: { display: false }
                    }]
                }
            }
        });

        // Day Compare Pie Chart
        new Chart(document.getElementById('dayCompareChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Hôm nay', 'Hôm qua'],
                datasets: [{
                    data: [listResultDate[0]?.count || 0, listResultDate[1]?.count || 0],
                    backgroundColor: [chartColors.blue, chartColors.gray],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutoutPercentage: 70,
                legend: {
                    position: 'bottom',
                    labels: { padding: 20 }
                }
            }
        });

        // Month Compare Pie Chart
        new Chart(document.getElementById('monthCompareChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Tháng này', 'Tháng trước'],
                datasets: [{
                    data: [listHitoryMonth[0]?.count || 0, listHitoryMonth[1]?.count || 0],
                    backgroundColor: [chartColors.purple, chartColors.gray],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutoutPercentage: 70,
                legend: {
                    position: 'bottom',
                    labels: { padding: 20 }
                }
            }
        });
    };

    fetchDashboardData();
</script>
