<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>

<div class="apple-wrapper">
    <aside class="apple-sidebar">
        <div class="apple-sidebar-logo">
            <a href="/admin/dashboard">
                <img src="/assets/logo/logo.png" alt="AdFuture">
                AdFuture
            </a>
        </div>
        
        <ul class="apple-nav">
            <li class="apple-nav-item">
                <a href="/admin/dashboard" class="apple-nav-link active">
                    <i class="fa-solid fa-chart-line"></i>
                    Lưu lượng truy cập
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/table" class="apple-nav-link">
                    <i class="fa-solid fa-box"></i>
                    Bảng tổng hợp sản phẩm
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/tablehomepage" class="apple-nav-link">
                    <i class="fa-solid fa-home"></i>
                    Sản phẩm trang chủ
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/editprice" class="apple-nav-link">
                    <i class="fa-solid fa-tags"></i>
                    Chỉnh sửa báo giá
                </a>
            </li>
            <li class="apple-nav-item">
                <a href="/admin/listRequestCustomer" class="apple-nav-link">
                    <i class="fa-solid fa-envelope"></i>
                    Ý kiến phản hồi
                    <span class="apple-nav-badge" id="notification_count_unreadrequest">0</span>
                </a>
            </li>
        </ul>
    </aside>

    <main class="apple-main">
        <header class="apple-header">
            <button class="apple-menu-toggle" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
            <h1 class="apple-header-title">Dashboard</h1>
            <div class="apple-header-actions">
                <a href="/admin/login" class="apple-btn apple-btn-secondary">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    Đăng xuất
                </a>
            </div>
        </header>

        <div class="apple-content">
            <div class="apple-grid apple-grid-4 mb-4" id="stats-grid">
                <div class="apple-stat-card">
                    <div class="apple-stat-value" id="stat-today">0</div>
                    <div class="apple-stat-label">Truy cập hôm nay</div>
                </div>
                <div class="apple-stat-card">
                    <div class="apple-stat-value" id="stat-yesterday">0</div>
                    <div class="apple-stat-label">Truy cập hôm qua</div>
                </div>
                <div class="apple-stat-card">
                    <div class="apple-stat-value" id="stat-month">0</div>
                    <div class="apple-stat-label">Truy cập tháng này</div>
                </div>
                <div class="apple-stat-card">
                    <div class="apple-stat-value" id="stat-lastmonth">0</div>
                    <div class="apple-stat-label">Truy cập tháng trước</div>
                </div>
            </div>

            <div class="apple-grid apple-grid-2 mb-4">
                <div class="apple-chart-container">
                    <h3 class="apple-chart-title">Thống kê theo ngày</h3>
                    <canvas id="dailyChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="apple-chart-container">
                    <h3 class="apple-chart-title">Thống kê theo tháng</h3>
                    <canvas id="monthlyChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div class="apple-grid apple-grid-2">
                <div class="apple-chart-container">
                    <h3 class="apple-chart-title">So sánh ngày</h3>
                    <canvas id="dayCompareChart" style="max-height: 300px;"></canvas>
                </div>
                <div class="apple-chart-container">
                    <h3 class="apple-chart-title">So sánh tháng</h3>
                    <canvas id="monthCompareChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <footer class="apple-footer">
            &copy; 2024 AdFuture. All rights reserved.
        </footer>
    </main>
</div>

<script>
    let tokenJWT = localStorage['token'];
    
    const chartColors = {
        blue: 'rgb(0, 113, 227)',
        purple: 'rgb(175, 82, 222)',
        gray: 'rgb(142, 142, 147)'
    };

    Chart.defaults.global.defaultFontFamily = "-apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif";

    const fetchDashboardData = async () => {
        try {
            const res = await axios({
                method: "post",
                url: "/api/admin/contact/CountUnreaderRequest",
                data: { tokenJWT },
                headers: { "Content-Type": "multipart/form-data" }
            });
            
            if (res?.data?.data?.count !== undefined) {
                localStorage.setItem('countUnreaderRequest', String(res.data.data.count));
                document.getElementById('notification_count_unreadrequest').textContent = res.data.data.count;
            }

            const chartRes = await axios({
                method: "post",
                url: "/api/admin/homepage/TakeDataChart",
                data: { tokenJWT },
                headers: { "Content-Type": "multipart/form-data" }
            });

            if (chartRes.data?.data) {
                renderCharts(chartRes.data.data);
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
        }
    };

    const renderCharts = (data) => {
        const { listResultDate, listHitoryMonth } = data;

        if (listResultDate && listResultDate.length >= 2) {
            document.getElementById('stat-today').textContent = listResultDate[0]?.count || 0;
            document.getElementById('stat-yesterday').textContent = listResultDate[1]?.count || 0;
        }
        if (listHitoryMonth && listHitoryMonth.length >= 2) {
            document.getElementById('stat-month').textContent = listHitoryMonth[0]?.count || 0;
            document.getElementById('stat-lastmonth').textContent = listHitoryMonth[1]?.count || 0;
        }

        if (listResultDate) {
            const dailyLabels = listResultDate.map(item => `${item.day}/${item.month}`);
            const dailyData = listResultDate.map(item => item.count);
            
            new Chart(document.getElementById('dailyChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Lượt truy cập',
                        data: dailyData,
                        backgroundColor: chartColors.blue
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    legend: { display: false },
                    scales: {
                        yAxes: [{ ticks: { beginAtZero: true }, gridLines: { color: 'rgba(0, 0, 0, 0.05)' } }],
                        xAxes: [{ gridLines: { display: false } }]
                    }
                }
            });

            new Chart(document.getElementById('dayCompareChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Hôm nay', 'Hôm qua'],
                    datasets: [{
                        data: [listResultDate[0]?.count || 0, listResultDate[1]?.count || 0],
                        backgroundColor: [chartColors.blue, chartColors.gray],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutoutPercentage: 70,
                    legend: { position: 'bottom', labels: { padding: 20 } }
                }
            });
        }

        if (listHitoryMonth) {
            const monthlyLabels = listHitoryMonth.map(item => `${item.month}/${item.year}`);
            const monthlyData = listHitoryMonth.map(item => item.count);
            
            new Chart(document.getElementById('monthlyChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Lượt truy cập',
                        data: monthlyData,
                        backgroundColor: chartColors.purple
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    legend: { display: false },
                    scales: {
                        yAxes: [{ ticks: { beginAtZero: true }, gridLines: { color: 'rgba(0, 0, 0, 0.05)' } }],
                        xAxes: [{ gridLines: { display: false } }]
                    }
                }
            });

            new Chart(document.getElementById('monthCompareChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Tháng này', 'Tháng trước'],
                    datasets: [{
                        data: [listHitoryMonth[0]?.count || 0, listHitoryMonth[1]?.count || 0],
                        backgroundColor: [chartColors.purple, chartColors.gray],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutoutPercentage: 70,
                    legend: { position: 'bottom', labels: { padding: 20 } }
                }
            });
        }
    };

    fetchDashboardData();
</script>
